<div
  class="min-h-screen flex flex-col builder-shell-root"
  [attr.data-theme]="currentTheme()"
>
  <header class="bg-primary text-white sticky top-0 z-20">
    <div class="px-6 py-4">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <h1 class="text-xl font-semibold">Dynamic Form Generator</h1>
          @if (userFillMode()) {
          <span
            class="text-xs bg-white/10 text-white px-3 py-1 rounded-full border border-white/20"
          >
            User fill mode Â· {{ formsService.getCurrentFormName() }}
          </span>
          }
        </div>
        <div class="flex items-center gap-2">
          <div class="relative flex items-center theme-trigger">
            <button
              type="button"
              class="theme-icon-btn"
              cdkOverlayOrigin
              #themeOrigin="cdkOverlayOrigin"
              (click)="toggleThemeMenu()"
              [attr.aria-label]="'Current theme ' + themeLabel()"
            >
              <svg viewBox="0 0 24 24" class="h-5 w-5">
                <path
                  fill="currentColor"
                  d="M3 3h8v2H5v6H3V3zm5 8h5V6h-2v3H8v2zm0 2h2v5H8v-5zm4-4h5v2h-5v-2zm0 4h2v5h-2v-5zm4-8h4v4h-2V7h-2V5z"
                />
              </svg>
              <span class="hidden sm:inline text-xs font-semibold"
                >{{ themeLabel() }}</span
              >
            </button>
            <ng-template
              cdkConnectedOverlay
              [cdkConnectedOverlayOrigin]="themeOrigin"
              [cdkConnectedOverlayOpen]="showThemeMenu()"
              [cdkConnectedOverlayHasBackdrop]="true"
              [cdkConnectedOverlayBackdropClass]="'theme-backdrop'"
              [cdkConnectedOverlayPanelClass]="'theme-overlay-pane'"
              [cdkConnectedOverlayPositions]="[
                {
                  originX: 'end',
                  originY: 'bottom',
                  overlayX: 'end',
                  overlayY: 'top',
                  offsetY: 8
                },
                {
                  originX: 'end',
                  originY: 'top',
                  overlayX: 'end',
                  overlayY: 'bottom',
                  offsetY: -8
                }
              ]"
              (backdropClick)="closeThemeMenu()"
              (detach)="closeThemeMenu()"
            >
              <div class="theme-dialog">
                <div class="theme-dialog__header">
                  <div>
                    <p class="eyebrow">Themes</p>
                    <h3>Select a vibe</h3>
                  </div>
                  <button type="button" class="chip" (click)="cycleTheme()">
                    Next
                  </button>
                </div>
                <div class="theme-dialog__grid">
                  @for (theme of themes; track theme.id) {
                  <button
                    type="button"
                    class="theme-card"
                    [class.theme-active]="theme.id === currentTheme()"
                    (click)="setTheme(theme.id); closeThemeMenu()"
                  >
                    <span
                      class="theme-swatch"
                      [style.background]="theme.accent"
                    ></span>
                    <div class="theme-text">
                      <p class="theme-name">{{ theme.name }}</p>
                    </div>
                  </button>
                  }
                </div>
              </div>
            </ng-template>
          </div>
          <a
            routerLink="/team"
            class="px-3 py-2 border border-white/25 text-white rounded-md font-medium text-sm hover:bg-white/10 transition"
          >
            Meet the makers
          </a>
          <button
            type="button"
            (click)="startTour(true)"
            class="px-3 py-2 bg-white text-primary rounded-md font-medium text-sm hover:bg-white/90"
          >
            Start tutorial
          </button>
        </div>
      </div>
    </div>
    <!-- Tabs Navigation -->
    @if (!userFillMode()) {
    <nav class="bg-card border-t border-border">
      <div class="px-6 flex gap-8">
        <button
          (click)="goToStep('forms')"
          class="py-4 px-2 border-b-2 font-medium transition-colors"
          [class.border-primary]="currentStep() === 'forms'"
          [class.text-primary]="currentStep() === 'forms'"
          [class.border-transparent]="currentStep() !== 'forms'"
          [class.text-muted]="currentStep() !== 'forms'"
        >
          Forms
        </button>
        <button
          (click)="goToStep('fields')"
          [disabled]="!hasActiveForm()"
          class="py-4 px-2 border-b-2 font-medium transition-colors"
          [class.border-primary]="currentStep() === 'fields'"
          [class.text-primary]="currentStep() === 'fields'"
          [class.border-transparent]="currentStep() !== 'fields'"
          [class.text-muted]="currentStep() !== 'fields' || !hasActiveForm()"
          [class.opacity-50]="!hasActiveForm()"
          [class.cursor-not-allowed]="!hasActiveForm()"
        >
          Builder
        </button>
        <button
          (click)="goToStep('rules')"
          [disabled]="!hasActiveForm()"
          class="py-4 px-2 border-b-2 font-medium transition-colors"
          [class.border-primary]="currentStep() === 'rules'"
          [class.text-primary]="currentStep() === 'rules'"
          [class.border-transparent]="currentStep() !== 'rules'"
          [class.text-muted]="currentStep() !== 'rules' || !hasActiveForm()"
          [class.opacity-50]="!hasActiveForm()"
          [class.cursor-not-allowed]="!hasActiveForm()"
        >
          Rules
        </button>
        <button
          (click)="goToStep('preview')"
          [disabled]="!hasActiveForm()"
          class="py-4 px-2 border-b-2 font-medium transition-colors"
          [class.border-primary]="currentStep() === 'preview'"
          [class.text-primary]="currentStep() === 'preview'"
          [class.border-transparent]="currentStep() !== 'preview'"
          [class.text-muted]="currentStep() !== 'preview' || !hasActiveForm()"
          [class.opacity-50]="!hasActiveForm()"
          [class.cursor-not-allowed]="!hasActiveForm()"
        >
          Preview
        </button>
      </div>
    </nav>
    }
  </header>

  <main class="p-6 pb-28 flex-1 overflow-auto">
    @if (currentStep() === 'forms') {
    <app-forms-step
      #formsCmp
      (nextStep)="onNextStep()"
      (backStep)="onBackStep()"
      (formSelected)="onFormSelected($event)"
      (startUserFill)="onUserFillStart($event)"
      (editSubmission)="onSubmissionEdit($event)"
    ></app-forms-step>
    } @else if (currentStep() === 'fields') {
    <app-fields-step
      [formName]="formsService.getCurrentFormName()"
      (nextStep)="onNextStep()"
      (backStep)="onBackStep()"
    ></app-fields-step>
    } @else if (currentStep() === 'rules') {
    <app-rules-step
      (nextStep)="onNextStep()"
      (backStep)="onBackStep()"
    ></app-rules-step>
    } @else if (currentStep() === 'preview') {
    <app-preview-step
      #previewCmp
      [initialValues]="initialValues()"
      (nextStep)="onPreviewSubmit($event)"
      (backStep)="onBackStep()"
    ></app-preview-step>
    }
  </main>

  <footer
    class="bg-white border-t border-border px-6 py-4 flex items-center justify-between gap-4 fixed bottom-0 left-0 right-0 z-20"
  >
    <div class="flex items-center gap-3">
      @if (currentStep() !== 'forms') {
      <button
        type="button"
        (click)="handleBackClick()"
        class="px-6 py-2 border border-border text-text rounded-md hover:bg-bg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Back
      </button>
      } @else {
      <span class="w-[84px]"></span>
      }
    </div>
    <div class="flex-1 text-center">
      @if (submissionSaved()) {
      <span class="text-sm text-muted">Submission saved to your browser.</span>
      }
    </div>
    <div>
      <button
        type="button"
        (click)="handleNextClick()"
        class="px-6 py-2 bg-primary text-white rounded-md hover:opacity-90 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
        [disabled]="isPrimaryDisabled()"
      >
        {{ currentStep() === 'preview' ? 'Submit' : 'Next' }}
      </button>
    </div>
  </footer>
  <app-builder-tour-overlay></app-builder-tour-overlay>
</div>
