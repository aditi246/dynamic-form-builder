<div class="flex flex-col gap-4 min-h-full">
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-semibold text-text mb-2">Forms</h2>
      <p class="text-muted">Create and manage your forms.</p>
    </div>
    <div class="flex items-center gap-3" data-tour-anchor="forms-actions">
      <button
        type="button"
        (click)="loadMockForm()"
        class="px-4 py-2 border border-border text-text rounded-md hover:bg-bg font-medium flex items-center gap-2"
      >
        <app-icon name="sparkle" class="w-5 h-5"></app-icon>
        Load Mock Form
      </button>
      <button
        type="button"
        (click)="openCreateModal()"
        class="px-4 py-2 bg-primary text-white rounded-md hover:opacity-90 font-medium flex items-center gap-2"
      >
        <app-icon name="plus" class="w-5 h-5"></app-icon>
        Create New Form
      </button>
    </div>
  </div>

  <div class="flex gap-6 flex-1 min-h-0">
    <div class="w-[60%] space-y-4" data-tour-anchor="forms-list">
      <!-- Forms List -->
      @if (formsService.forms().length === 0) {
      <div class="bg-card rounded-md shadow-sm p-6 border border-border">
        <div class="text-center py-12">
          <p class="text-muted mb-4">
            No forms saved yet. Create your first form to get started.
          </p>
          <button
            type="button"
            (click)="openCreateModal()"
            class="px-4 py-2 bg-primary text-white rounded-md hover:opacity-90 font-medium"
          >
            Create Form
          </button>
        </div>
      </div>
      } @else {
      <div
        class="bg-card rounded-md shadow-sm border border-border overflow-hidden"
      >
        <table class="w-full">
          <thead class="bg-bg border-b border-border">
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-semibold text-text uppercase tracking-wider"
              >
                Form Name
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-semibold text-text uppercase tracking-wider"
              >
                Last Updated
              </th>
              <th
                class="px-6 py-3 text-right text-xs font-semibold text-text uppercase tracking-wider"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            @for (form of formsService.forms(); track form.id) {
            <tr
              (click)="selectForm(form.id)"
              class="hover:bg-bg cursor-pointer transition-colors"
            >
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-text">{{ form.name }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-muted">
                  {{ formatDate(form.updatedAt) }}
                </div>
              </td>
              <td
                class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium cursor-default"
                (click)="$event.stopPropagation()"
              >
                <div class="flex items-center justify-end gap-3 cursor-default">
                  <button
                    type="button"
                    (click)="viewSubmissions($event, form)"
                    class="p-1 text-muted hover:text-primary transition-colors cursor-pointer"
                    title="View submissions"
                    data-tour-anchor="forms-action-view"
                  >
                    <app-icon name="list" class="w-4 h-4"></app-icon>
                  </button>
                  <button
                    type="button"
                    (click)="copyForm($event, form.id)"
                    class="p-1 text-muted hover:text-primary transition-colors cursor-pointer"
                    title="Copy form"
                    data-tour-anchor="forms-action-copy"
                  >
                    <app-icon name="copy" class="w-4 h-4"></app-icon>
                  </button>
                  <button
                    type="button"
                    (click)="openFillModal(form, $event)"
                    class="p-1 text-muted hover:text-primary transition-colors cursor-pointer"
                    title="Fill form as user"
                    data-tour-anchor="forms-action-fill"
                  >
                    <app-icon name="home" class="w-4 h-4"></app-icon>
                  </button>
                  <button
                    type="button"
                    (click)="editForm($event, form.id)"
                    class="p-1 text-muted hover:text-primary transition-colors cursor-pointer"
                    title="Edit form"
                    data-tour-anchor="forms-action-edit"
                  >
                    <app-icon name="edit" class="w-4 h-4"></app-icon>
                  </button>
                  <button
                    type="button"
                    (click)="deleteForm($event, form.id)"
                    class="p-1 text-muted hover:text-danger transition-colors cursor-pointer"
                    title="Delete form"
                    data-tour-anchor="forms-action-delete"
                  >
                    <app-icon name="delete" class="w-4 h-4"></app-icon>
                  </button>
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
      }
    </div>

    <div class="w-[40%]" data-tour-anchor="forms-submissions">
      <div
        class="bg-card border border-border rounded-md shadow-sm p-5 h-full flex flex-col gap-3"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-text">Saved submissions</h3>
            <p class="text-sm text-muted">
              Pick a form to view and edit user submissions.
            </p>
          </div>
          @if (submissionsFormId()) {
          <span
            class="text-xs px-2 py-1 rounded-full bg-bg border border-border text-muted"
          >
            {{ submissions().length }} saved
          </span>
          }
        </div>

        @if (!submissionsFormId()) {
        <div class="text-sm text-muted flex-1 flex items-center">
          Select "View submissions" on a form to load its data.
        </div>
        } @else if (submissions().length === 0) {
        <div class="text-sm text-muted flex-1 flex items-center">
          No submissions stored for this form yet.
        </div>
        } @else {
        <div class="flex-1 grid grid-cols-1 gap-3 overflow-y-auto">
          <div class="space-y-2 max-h-[480px] overflow-y-auto pr-1">
            @for (entry of submissions(); track entry.id) {
            <div
              class="border border-border rounded-md p-3 cursor-pointer hover:border-primary/70 transition"
              [class.bg-bg]="selectedSubmission()?.id === entry.id"
              (click)="selectSubmission(entry)"
            >
              <div class="flex items-center justify-between">
                <div class="text-sm font-medium text-text">
                  Submission {{ entry.id.slice(0, 6) }}â€¦
                </div>
                <div class="text-xs text-muted">
                  {{ formatDate(entry.submittedAt) }}
                </div>
              </div>
              @if (entry.context && entry.context.length) {
              <div class="flex flex-wrap gap-2 mt-2">
                @for (ctx of entry.context; track ctx.key) {
                <span
                  class="text-2xs px-2 py-1 rounded-full bg-bg border border-border text-muted"
                  >{{ ctx.displayName }}: {{ ctx.value }}</span
                >
                }
              </div>
              }
            </div>
            }
          </div>

          @if (selectedSubmission()) {
          <div class="border border-border rounded-md p-3 bg-bg space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-text">
                  Submission details
                </p>
                <p class="text-xs text-muted">
                  Tap edit to modify and re-save.
                </p>
              </div>
              <button
                type="button"
                (click)="editSelectedSubmission()"
                class="px-3 py-1.5 bg-primary text-white rounded-md text-xs hover:opacity-90"
              >
                Edit in form
              </button>
            </div>
            <pre
              class="text-xs text-text whitespace-pre-wrap break-words max-h-60 overflow-auto border border-border rounded-md bg-card p-3"
            >
{{ selectedSubmission()?.values | json }}</pre
            >
          </div>
          }
        </div>
        }
      </div>
    </div>
  </div>

  <!-- Create Form Modal -->
  @if (showCreateModal()) {
  <div
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    (click)="closeCreateModal()"
  >
    <div
      class="bg-card rounded-md shadow-lg p-6 max-w-md w-full mx-4 border border-border"
      (click)="$event.stopPropagation()"
    >
      <h3 class="text-xl font-semibold text-text mb-4">Create New Form</h3>
      <form
        [formGroup]="createFormGroup"
        (ngSubmit)="createForm()"
        class="space-y-4"
      >
        <div>
          <label class="block text-sm font-medium text-text mb-2"
            >Form Name</label
          >
          <input
            type="text"
            formControlName="name"
            placeholder="Enter form name"
            class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
            [class.border-danger]="createFormGroup.get('name')?.invalid && createFormGroup.get('name')?.touched"
          />
          @if (createFormGroup.get('name')?.invalid &&
          createFormGroup.get('name')?.touched) {
          <p class="text-sm text-danger mt-1">Form name is required</p>
          }
        </div>
        <div class="flex justify-end gap-3">
          <button
            type="button"
            (click)="closeCreateModal()"
            class="px-4 py-2 border border-border text-text rounded-md hover:bg-bg font-medium"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-primary text-white rounded-md hover:opacity-90 font-medium"
          >
            Create
          </button>
        </div>
      </form>
    </div>
  </div>
  } @if (showFillModal()) {
  <div
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    (click)="closeFillModal()"
  >
    <div
      class="bg-card rounded-md shadow-lg p-6 max-w-md w-full mx-4 border border-border"
      (click)="$event.stopPropagation()"
      data-tour-anchor="forms-fill-context"
    >
      <h3 class="text-xl font-semibold text-text mb-2">Fill form as a user</h3>
      <p class="text-xs text-muted mb-4">
        Provide user context values for this session. Leave blank to skip.
      </p>
      <form
        [formGroup]="fillContextForm"
        (ngSubmit)="launchUserFill()"
        class="space-y-4"
      >
        @if ((fillContextDefs() ?? []).length === 0) {
        <div class="text-sm text-muted">
          No user context defined for this form. You can still continue.
        </div>
        } @else {
        <div class="space-y-3 max-h-[360px] overflow-auto pr-1">
          @for (ctx of fillContextDefs() ?? []; track ctx.key) {
          <div class="space-y-1">
            <label class="block text-sm font-medium text-text">
              {{ ctx.displayName || ctx.key }}
            </label>
            <input
              [formControlName]="ctx.key"
              type="text"
              class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
              [placeholder]="ctx.displayName || ctx.key"
            />
          </div>
          }
        </div>
        }
        <div class="flex justify-end gap-3">
          <button
            type="button"
            (click)="closeFillModal()"
            class="px-4 py-2 border border-border text-text rounded-md hover:bg-bg font-medium"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-primary text-white rounded-md hover:opacity-90 font-medium"
          >
            Continue to form
          </button>
        </div>
      </form>
    </div>
  </div>
  }
</div>
