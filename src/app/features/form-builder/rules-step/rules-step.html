<div class="max-w-5xl mx-auto space-y-6">
  <div>
    <h2 class="text-2xl font-semibold text-text mb-2">Rules & Dynamic Logic</h2>
    <p class="text-muted">
      Build conditional validations and visibility rules that react to other field values (e.g. hide License Expiry when "License Unlimited" is true or enforce expiry days by store type).
    </p>
  </div>

  <form [formGroup]="ruleForm" class="bg-card rounded-md shadow-sm p-6 border border-border space-y-6">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-lg font-semibold text-text">Compose a rule</h3>
        <p class="text-sm text-muted">Stack conditions, then choose what happens to the target field.</p>
      </div>
      @if (editingRuleId()) {
        <button
          type="button"
          (click)="cancelEditing()"
          class="px-3 py-2 border border-border text-text rounded-md hover:bg-bg text-sm"
        >
          Cancel edit
        </button>
      }
    </div>

    <div class="grid md:grid-cols-2 gap-6">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Rule name</label>
          <input
            type="text"
            formControlName="name"
            placeholder="e.g. Mall license under 30 days"
            class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
          />
        </div>

        <div class="border border-border rounded-md p-4">
          <div class="flex items-center justify-between mb-3">
            <div>
              <p class="text-sm font-semibold text-text">When these conditions are true</p>
              <p class="text-xs text-muted">All conditions are combined with AND.</p>
            </div>
            <div class="text-xs text-muted">{{ conditions().length }} added</div>
          </div>

          <div [formGroup]="conditionDraft" class="grid grid-cols-3 gap-3">
            <select
              formControlName="field"
              class="px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
            >
              <option value="">Select field</option>
              @for (field of fields(); track field.name) {
                <option [value]="field.name">{{ field.label }}</option>
              }
            </select>

            <select
              formControlName="operator"
              class="px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
            >
              @for (op of conditionOperators; track op.value) {
                <option [value]="op.value">{{ op.label }}</option>
              }
            </select>

            @if (isSelectField(conditionDraft.value.field || '')) {
              <select
                formControlName="multiValues"
                multiple
                class="px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card h-full"
              >
                @for (opt of getSelectOptions(conditionDraft.value.field || ''); track opt) {
                  <option [value]="opt">{{ opt }}</option>
                }
              </select>
            } @else {
              <input
                type="text"
                formControlName="value"
                placeholder="Value (skip for is true/false)"
                class="px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
              />
            }
          </div>

          <div class="flex justify-end mt-3">
            <button
              type="button"
              (click)="addCondition()"
              class="px-3 py-2 bg-primary text-white rounded-md hover:opacity-90 text-sm font-medium flex items-center gap-2"
            >
              <app-icon name="plus" class="w-4 h-4"></app-icon>
              Add condition
            </button>
          </div>

          @if (conditions().length > 0) {
            <div class="mt-3 space-y-2">
              @for (condition of conditions(); track condition.field + condition.operator + condition.value) {
                <div class="flex items-center justify-between px-3 py-2 bg-bg rounded-md border border-border">
                  <p class="text-sm text-text">{{ conditionText(condition) }}</p>
                  <button
                    type="button"
                    (click)="removeCondition($index)"
                    class="text-muted hover:text-danger transition-colors"
                  >
                    <app-icon name="delete" class="w-4 h-4"></app-icon>
                  </button>
                </div>
              }
            </div>
          }
        </div>
      </div>

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-text mb-2">Target field</label>
          <select
            formControlName="targetField"
            class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
          >
            <option value="">Select target field</option>
            @for (field of targetFields(); track field.name) {
              <option [value]="field.name">{{ field.label }}</option>
            }
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-text mb-2">Action</label>
          <div class="grid grid-cols-2 gap-3 mb-4">
            <label class="flex items-center gap-2 px-3 py-2 border border-border rounded-md cursor-pointer">
              <input type="radio" formControlName="actionType" value="validation" />
              <span class="text-sm text-text">Add validation</span>
            </label>
            <label class="flex items-center gap-2 px-3 py-2 border border-border rounded-md cursor-pointer">
              <input type="radio" formControlName="actionType" value="visibility" />
              <span class="text-sm text-text">Toggle visibility</span>
            </label>
          </div>

          @if (isValidationAction()) {
            <div class="space-y-3 border border-border rounded-md p-4">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-sm font-medium text-text mb-2">Comparator</label>
                  <select
                    formControlName="comparator"
                    class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                  >
                    @for (comp of comparators; track comp.value) {
                      <option [value]="comp.value">{{ comp.label }}</option>
                    }
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-text mb-2">Compare against</label>
                  <select
                    formControlName="thresholdType"
                    class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                  >
                    <option value="static">Static value</option>
                    <option value="field">Another field</option>
                  </select>
                </div>
              </div>

              @if (ruleForm.value.thresholdType === 'field') {
                <div>
                  <label class="block text-sm font-medium text-text mb-2">Comparison field</label>
                  <select
                    formControlName="thresholdField"
                    class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                  >
                    <option value="">Select field</option>
                    @for (field of targetFields(); track field.name) {
                      <option [value]="field.name">{{ field.label }}</option>
                    }
                  </select>
                </div>
              } @else {
                <div>
                  <label class="block text-sm font-medium text-text mb-2">Value</label>
                  <input
                    type="number"
                    formControlName="thresholdValue"
                    placeholder="e.g. 30"
                    class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                  />
                </div>
              }

              <div>
                <label class="block text-sm font-medium text-text mb-2">Error message</label>
                <input
                  type="text"
                  formControlName="errorMessage"
                  placeholder="Shown when validation fails"
                  class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                />
              </div>
            </div>
          } @else {
            <div class="space-y-3 border border-border rounded-md p-4">
              <label class="flex items-center gap-2 text-sm text-text">
                <input
                  type="radio"
                  formControlName="visibilityBehavior"
                  value="hide"
                />
                <span>Hide the target field when conditions match</span>
              </label>
              <label class="flex items-center gap-2 text-sm text-text">
                <input
                  type="radio"
                  formControlName="visibilityBehavior"
                  value="show"
                />
                <span>Show the target field when conditions match</span>
              </label>
              <p class="text-xs text-muted">
                Hidden fields are automatically disabled so they do not block form submission.
              </p>
            </div>
          }
        </div>

        <div class="flex justify-end gap-3">
          <button
            type="button"
            (click)="resetForms()"
            class="px-4 py-2 border border-border text-text rounded-md hover:bg-bg font-medium"
          >
            Reset
          </button>
          <button
            type="button"
            (click)="saveRule(true)"
            class="px-4 py-2 bg-primary/80 text-white rounded-md hover:opacity-90 font-medium"
          >
            Save & add another for this target
          </button>
          <button
            type="button"
            (click)="saveRule()"
            class="px-4 py-2 bg-primary text-white rounded-md hover:opacity-90 font-medium"
          >
            {{ editingRuleId() ? 'Update rule' : 'Add rule' }}
          </button>
        </div>
      </div>
    </div>
  </form>

  <div class="bg-card rounded-md shadow-sm p-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold text-text">Existing rules (grouped by target)</h3>
        <p class="text-sm text-muted">All rules attached to the same target field stay together.</p>
      </div>
    </div>

    @if (rules().length === 0) {
      <div class="text-center py-12 text-muted">
        <p>No rules yet. Add a rule above to wire up conditional validation and visibility.</p>
      </div>
    } @else {
      <div class="space-y-4">
        @for (group of groupedRules(); track group.targetField) {
          <div class="border border-border rounded-md">
            <div class="flex items-center justify-between px-4 py-3 bg-bg border-b border-border">
              <div>
                <p class="text-sm font-semibold text-text">{{ getFieldLabel(group.targetField) }}</p>
                <p class="text-xs text-muted">{{ group.rules.length }} rule(s)</p>
              </div>
            </div>
            <div class="divide-y divide-border">
              @for (rule of group.rules; track rule.id) {
                <div class="flex items-start justify-between px-4 py-3">
                  <div class="space-y-1">
                    <p class="text-sm font-semibold text-text">{{ rule.name }}</p>
                    <p class="text-sm text-muted">{{ formatRule(rule) }}</p>
                  </div>
                  <div class="flex items-center gap-3">
                    <button
                      (click)="editRule(rule)"
                      class="text-muted hover:text-primary transition-colors"
                    >
                      <app-icon name="edit" class="w-5 h-5"></app-icon>
                    </button>
                    <button
                      (click)="deleteRule(rule.id)"
                      class="text-muted hover:text-danger transition-colors"
                    >
                      <app-icon name="delete" class="w-5 h-5"></app-icon>
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
  </div>

  <div class="flex justify-between">
    <button 
      type="button"
      (click)="backStep.emit()"
      class="px-6 py-2 border border-border text-text rounded-md hover:bg-bg font-medium">
      Back
    </button>
    <button 
      type="button"
      (click)="nextStep.emit()"
      class="px-6 py-2 bg-success text-white rounded-md hover:opacity-90 font-medium">
      Next
    </button>
  </div>
</div>
