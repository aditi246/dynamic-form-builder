<div class="flex flex-col gap-4 min-h-full">
  <div class="flex gap-6 flex-1 min-h-0">
    <!-- Existing rules (left, 40%) -->
    <div
      class="w-[40%] bg-card rounded-md shadow-sm p-6 flex flex-col overflow-hidden min-h-0 h-[calc(100vh-260px)]"
    >
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-semibold text-text">
            Existing rules (grouped by target)
          </h3>
          <p class="text-sm text-muted">
            All rules attached to the same target field stay together.
          </p>
        </div>
        <div
          class="flex items-center gap-2"
          data-tour-anchor="rules-user-context"
        >
          <button
            type="button"
            (click)="openContextModal()"
            class="px-2 py-1 text-xs border border-border rounded-md text-text hover:bg-bg"
          >
            User context
          </button>
          <button
            type="button"
            (click)="expandAllGroups()"
            class="px-2 py-1 text-xs border border-border rounded-md text-text hover:bg-bg"
          >
            Expand all
          </button>
          <button
            type="button"
            (click)="collapseAllGroups()"
            class="px-2 py-1 text-xs border border-border rounded-md text-text hover:bg-bg"
          >
            Collapse all
          </button>
        </div>
      </div>

      @if (rules().length === 0) {
      <div
        class="text-center py-12 text-muted flex-1 flex items-center justify-center"
      >
        <p>
          No rules yet. Add a rule to wire up conditional validation and
          visibility.
        </p>
      </div>
      } @else {
      <div class="space-y-4 flex-1 overflow-auto pr-1">
        @for (group of groupedRules(); track group.targetField) {
        <div class="border border-border rounded-md">
          <button
            type="button"
            class="w-full flex items-center justify-between px-4 py-3 bg-bg border-b border-border text-left"
            (click)="toggleGroup(group.targetField)"
          >
            <div class="flex items-center gap-2">
              <app-icon
                name="chevron-down"
                class="w-4 h-4 text-muted transition-transform transform"
                [class.rotate-180]="isGroupCollapsed(group.targetField)"
              ></app-icon>
              <div>
                <p class="text-sm font-semibold text-text">
                  {{ getFieldLabel(group.targetField) }}
                </p>
                <p class="text-xs text-muted">
                  {{ group.rules.length }} rule(s)
                </p>
              </div>
            </div>
            <span class="text-xs text-muted">
              {{ isGroupCollapsed(group.targetField) ? 'Expand' : 'Collapse' }}
            </span>
          </button>
          @if (!isGroupCollapsed(group.targetField)) {
          <div class="divide-y divide-border">
            @for (rule of group.rules; track rule.id) {
            <div class="flex items-start justify-between px-4 py-3">
              <div class="space-y-1">
                <p class="text-sm font-semibold text-text">{{ rule.name }}</p>
                <p class="text-sm text-muted">{{ formatRule(rule) }}</p>
              </div>
              <div class="flex items-center gap-3">
                <button
                  (click)="editRule(rule)"
                  class="text-muted hover:text-primary transition-colors"
                >
                  <app-icon name="edit" class="w-5 h-5"></app-icon>
                </button>
                <button
                  (click)="deleteRule(rule.id)"
                  class="text-muted hover:text-danger transition-colors"
                >
                  <app-icon name="delete" class="w-5 h-5"></app-icon>
                </button>
              </div>
            </div>
            }
          </div>
          }
        </div>
        }
      </div>
      }
    </div>

    <!-- Rule creation (right, 60%) -->
    <form
      [formGroup]="ruleForm"
      class="w-[60%] bg-card rounded-md shadow-sm p-6 border border-border space-y-6 flex flex-col overflow-hidden min-h-0 h-[calc(100vh-260px)]"
      data-tour-anchor="rules-builder"
    >
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-lg font-semibold text-text">Compose a rule</h3>
          <p class="text-sm text-muted">
            Stack conditions, then choose what happens to the target field.
          </p>
        </div>
        <div
          class="flex flex-col gap-2 items-end"
          data-tour-anchor="rules-api-refresh"
        >
          <div class="flex gap-2">
            <button
              type="button"
              (click)="refreshAllOptions()"
              class="px-3 py-2 border border-border text-text rounded-md hover:bg-bg text-xs"
            >
              Refresh API options
            </button>
            <button
              type="button"
              (click)="clearApiCache()"
              class="px-3 py-2 border border-border text-text rounded-md hover:bg-bg text-xs"
            >
              Clear API cache
            </button>
          </div>
          @if (editingRuleId()) {
          <button
            type="button"
            (click)="cancelEditing()"
            class="px-3 py-2 border border-border text-text rounded-md hover:bg-bg text-sm w-full"
          >
            Cancel edit
          </button>
          }
        </div>
      </div>

      <div class="flex-1 overflow-y-auto pr-1 space-y-6">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-text mb-2"
                >Rule name</label
              >
              <input
                type="text"
                formControlName="name"
                placeholder="e.g. Mall license under 30 days"
                class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                [class.border-danger]="isInvalid('name')"
                [class.border-border]="!isInvalid('name')"
              />
              @if (isInvalid('name')) {
              <p class="text-xs text-danger mt-1">Rule name is required.</p>
              }
            </div>

            <div
              class="border border-border rounded-md p-4"
              data-tour-anchor="rules-compose"
            >
              <div class="flex items-center justify-between mb-3">
                <div>
                  <p class="text-sm font-semibold text-text">
                    When these conditions are true
                  </p>
                  <p class="text-xs text-muted">
                    All conditions are combined with AND.
                  </p>
                </div>
                <div class="text-xs text-muted">
                  {{ conditions().length }} added
                </div>
              </div>

              <div [formGroup]="conditionDraft" class="grid grid-cols-3 gap-3">
                <select
                  formControlName="field"
                  class="px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                >
                  <option value="">Select field</option>
                  <optgroup label="User data">
                    @for (ctx of userContextEntries(); track ctx.key) {
                    <option [value]="ctx.key">
                      {{ ctx.displayName || ctx.key }}
                    </option>
                    }
                  </optgroup>
                  <optgroup label="Form fields">
                    @for (field of fields(); track field.name) {
                    <option [value]="field.name">{{ field.label }}</option>
                    }
                  </optgroup>
                </select>

                <select
                  formControlName="operator"
                  class="px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                >
                  @for (op of conditionOperators; track op.value) {
                  <option [value]="op.value">{{ op.label }}</option>
                  }
                </select>

                @if (isSelectField(conditionDraft.value.field || '')) {
                <div class="space-y-1">
                  <select
                    formControlName="multiValues"
                    multiple
                    class="px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card h-full"
                  >
                    @if (isOptionsLoading(conditionDraft.value.field || '')) {
                    <option disabled>Loading...</option>
                    } @for (opt of getSelectOptions(conditionDraft.value.field
                    || ''); track opt) {
                    <option [value]="opt">{{ opt }}</option>
                    }
                  </select>
                  @if (getOptionError(conditionDraft.value.field || '')) {
                  <p class="text-xs text-danger">
                    {{ getOptionError(conditionDraft.value.field || '') }}
                  </p>
                  } @else if (!isOptionsLoading(conditionDraft.value.field ||
                  '') && getSelectOptions(conditionDraft.value.field ||
                  '').length === 0) {
                  <p class="text-xs text-muted">
                    No options available for this field.
                  </p>
                  }
                </div>
                } @else {
                <input
                  type="text"
                  formControlName="value"
                  placeholder="Value (skip for is true/false)"
                  class="px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                />
                }
              </div>

              <div class="flex justify-end mt-3">
                <button
                  type="button"
                  (click)="addCondition()"
                  class="px-3 py-2 bg-primary text-white rounded-md hover:opacity-90 text-sm font-medium flex items-center gap-2"
                >
                  <app-icon name="plus" class="w-4 h-4"></app-icon>
                  Add condition
                </button>
              </div>

              @if (conditions().length > 0) {
              <div class="mt-3 space-y-2">
                @for (condition of conditions(); track condition.field +
                condition.operator + condition.value) {
                <div
                  class="flex items-center justify-between px-3 py-2 bg-bg rounded-md border border-border"
                >
                  <p class="text-sm text-text">
                    {{ conditionText(condition) }}
                  </p>
                  <button
                    type="button"
                    (click)="removeCondition($index)"
                    class="text-muted hover:text-danger transition-colors"
                  >
                    <app-icon name="delete" class="w-4 h-4"></app-icon>
                  </button>
                </div>
                }
              </div>
              }
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-text mb-2"
                >Target field</label
              >
              <select
                formControlName="targetField"
                class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                [class.border-danger]="isInvalid('targetField')"
                [class.border-border]="!isInvalid('targetField')"
              >
                <option value="">Select target field</option>
                @for (field of fields(); track field.name) {
                <option [value]="field.name">{{ field.label }}</option>
                }
              </select>
              @if (isInvalid('targetField')) {
              <p class="text-xs text-danger mt-1">
                Please select a target field.
              </p>
              }
            </div>

            <div>
              <label class="block text-sm font-medium text-text mb-2"
                >Action</label
              >
              <div
                class="grid gap-3 mb-4"
                [class.grid-cols-3]="isTargetSelect()"
                [class.grid-cols-2]="!isTargetSelect()"
              >
                <label
                  class="flex items-center gap-2 px-3 py-2 border border-border rounded-md cursor-pointer"
                >
                  <input
                    type="radio"
                    formControlName="actionType"
                    value="validation"
                  />
                  <span class="text-sm text-text">Add validation</span>
                </label>
                <label
                  class="flex items-center gap-2 px-3 py-2 border border-border rounded-md cursor-pointer"
                >
                  <input
                    type="radio"
                    formControlName="actionType"
                    value="visibility"
                  />
                  <span class="text-sm text-text">Toggle visibility</span>
                </label>
                @if (isTargetSelect()) {
                <label
                  class="flex items-center gap-2 px-3 py-2 border border-border rounded-md cursor-pointer"
                >
                  <input
                    type="radio"
                    formControlName="actionType"
                    value="options"
                  />
                  <span class="text-sm text-text">Hide options</span>
                </label>
                }
              </div>
              @if (isInvalid('actionType')) {
              <p class="text-xs text-danger mt-1">Please choose an action.</p>
              } @if (isValidationAction()) {
              <div
                class="space-y-3 border border-border rounded-md p-4"
                data-tour-anchor="rules-validation"
              >
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-sm font-medium text-text mb-2"
                      >Comparator</label
                    >
                    <select
                      formControlName="comparator"
                      class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                    >
                      @for (comp of getComparatorOptions(); track comp.value) {
                      <option [value]="comp.value">{{ comp.label }}</option>
                      }
                    </select>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-text mb-2"
                      >Compare against</label
                    >
                    <select
                      formControlName="thresholdType"
                      class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                    >
                      <option value="static">Static value</option>
                      <option value="field">Another field</option>
                    </select>
                    <p class="text-xs text-muted mt-1">
                      Static: compare with a fixed value. Another field: compare
                      against another field's live value.
                    </p>
                  </div>
                </div>

                @if (ruleForm.value.thresholdType === 'field') {
                <div>
                  <label class="block text-sm font-medium text-text mb-2"
                    >Comparison field</label
                  >
                  <select
                    formControlName="thresholdField"
                    class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                    [class.border-danger]="hasError('thresholdField', 'required')"
                    [class.border-border]="!hasError('thresholdField', 'required')"
                  >
                    <option value="">Select field</option>
                    @for (field of targetFields(); track field.name) {
                    <option [value]="field.name">{{ field.label }}</option>
                    }
                  </select>
                  @if (hasError('thresholdField', 'required')) {
                  <p class="text-xs text-danger mt-1">
                    Please choose a comparison field.
                  </p>
                  } @if (isTargetNumericOrDate()) {
                  <div class="mt-2">
                    <label class="block text-xs font-medium text-text mb-1"
                      >Offset (adds to comparison field)</label
                    >
                    <input
                      type="number"
                      formControlName="thresholdOffset"
                      placeholder="e.g. 15"
                      class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                    />
                  </div>
                  }
                </div>
                } @else { @if (isTargetNumericOrDate()) {
                <div>
                  <label class="block text-sm font-medium text-text mb-2"
                    >Value</label
                  >
                  <input
                    [type]="getTargetField()?.type === 'date' ? 'date' : 'number'"
                    formControlName="thresholdValue"
                    placeholder="e.g. 30"
                    class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                    [class.border-danger]="hasError('thresholdValue', 'required')"
                    [class.border-border]="!hasError('thresholdValue', 'required')"
                  />
                  @if (hasError('thresholdValue', 'required')) {
                  <p class="text-xs text-danger mt-1">Value is required.</p>
                  }
                </div>
                } @else if (getTargetField()?.type === 'select') {
                <div>
                  <label class="block text-sm font-medium text-text mb-2"
                    >Select value</label
                  >
                  <select
                    formControlName="thresholdValue"
                    class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                    [class.border-danger]="hasError('thresholdValue', 'required')"
                    [class.border-border]="!hasError('thresholdValue', 'required')"
                  >
                    <option value="">Choose option</option>
                    @for (opt of getStaticValueOptionsForTarget(); track
                    opt.value) {
                    <option [value]="opt.value">{{ opt.label }}</option>
                    }
                  </select>
                  @if (hasError('thresholdValue', 'required')) {
                  <p class="text-xs text-danger mt-1">Please pick a value.</p>
                  } @if (isOptionsLoading(getTargetField()?.name || '')) {
                  <p class="text-xs text-muted mt-1">Loading options...</p>
                  } @else if (getStaticValueOptionsForTarget().length === 0) {
                  <p class="text-xs text-muted mt-1">
                    No options available for this select.
                  </p>
                  }
                </div>
                } @else {
                <div>
                  <label class="block text-sm font-medium text-text mb-2"
                    >Value</label
                  >
                  <input
                    type="text"
                    formControlName="thresholdValue"
                    placeholder="Enter value"
                    class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                    [class.border-danger]="hasError('thresholdValue', 'required')"
                    [class.border-border]="!hasError('thresholdValue', 'required')"
                  />
                  @if (hasError('thresholdValue', 'required')) {
                  <p class="text-xs text-danger mt-1">Value is required.</p>
                  }
                </div>
                } }

                <div>
                  <label class="block text-sm font-medium text-text mb-2"
                    >Error message</label
                  >
                  <input
                    type="text"
                    formControlName="errorMessage"
                    placeholder="Shown when validation fails"
                    class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                  />
                </div>
              </div>
              } @else if (ruleForm.value.actionType === 'options') {
              <div
                class="space-y-3 border border-border rounded-md p-4"
                data-tour-anchor="rules-hide-options"
              >
                <p class="text-sm text-text">
                  Control which options are visible for the target select.
                </p>

                <div
                  class="flex flex-col gap-2 sm:flex-row sm:items-center sm:gap-4"
                >
                  <label class="flex items-center gap-2 text-sm text-text">
                    <input
                      type="radio"
                      value="static"
                      formControlName="optionHideMode"
                    />
                    <span>Hide specific values</span>
                  </label>
                  <label class="flex items-center gap-2 text-sm text-text">
                    <input
                      type="radio"
                      value="source-field"
                      formControlName="optionHideMode"
                    />
                    <span>Hide value selected in another select</span>
                  </label>
                </div>

                @if (ruleForm.value.optionHideMode === 'source-field') {
                <div class="space-y-2">
                  <label class="block text-sm font-medium text-text"
                    >Source select(s)</label
                  >
                  <select
                    formControlName="optionSourceField"
                    multiple
                    class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                    [class.border-danger]="
                      hasError('optionSourceField', 'required')
                    "
                    [class.border-border]="
                      !hasError('optionSourceField', 'required')
                    "
                  >
                    @for (field of optionSourceFields(); track field.name) {
                    <option [value]="field.name">{{ field.label }}</option>
                    }
                  </select>
                  @if (hasError('optionSourceField', 'required')) {
                  <p class="text-xs text-danger mt-1">
                    Please pick at least one source select field.
                  </p>
                  } @else if (optionSourceFields().length === 0) {
                  <p class="text-xs text-muted">
                    Add another select field to use as the source.
                  </p>
                  } @else {
                  <p class="text-xs text-muted">
                    The currently selected values from the chosen sources will
                    be removed from the target options.
                  </p>
                  }
                </div>
                } @else {
                <div class="space-y-2">
                  <label class="block text-sm font-medium text-text"
                    >Hide these values</label
                  >
                  <select
                    formControlName="hideOptionValues"
                    multiple
                    class="w-full px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
                  >
                    @for (opt of getStaticValueOptionsForTarget(); track
                    opt.value) {
                    <option [value]="opt.value">{{ opt.label }}</option>
                    }
                  </select>
                  @if (getStaticValueOptionsForTarget().length === 0) {
                  <p class="text-xs text-muted">
                    No options available for this target. Select a select-type
                    target field.
                  </p>
                  } @if (ruleForm.value.hideOptionValues?.length) {
                  <div class="flex flex-wrap gap-2 mt-2">
                    @for (optValue of ruleForm.value.hideOptionValues; track
                    optValue) {
                    <span
                      class="px-2 py-1 bg-card border border-border rounded text-xs text-text"
                    >
                      {{ getOptionLabel(optValue) }}
                    </span>
                    }
                  </div>
                  }
                </div>
                }
              </div>
              } @else {
              <div
                class="space-y-3 border border-border rounded-md p-4"
                data-tour-anchor="rules-visibility"
              >
                <label class="flex items-center gap-2 text-sm text-text">
                  <input
                    type="radio"
                    formControlName="visibilityBehavior"
                    value="hide"
                  />
                  <span>Hide the target field when conditions match</span>
                </label>
                <label class="flex items-center gap-2 text-sm text-text">
                  <input
                    type="radio"
                    formControlName="visibilityBehavior"
                    value="show"
                  />
                  <span>Show the target field when conditions match</span>
                </label>
                <p class="text-xs text-muted">
                  Hidden fields are automatically disabled so they do not block
                  form submission.
                </p>
              </div>
              }
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-3 mt-auto pt-4">
        <button
          type="button"
          (click)="resetForms()"
          class="w-full px-4 py-2 border border-border text-text rounded-md hover:bg-bg font-medium"
        >
          Reset
        </button>
        <button
          type="button"
          (click)="saveRule(true)"
          class="w-full px-4 py-2 bg-primary/80 text-white rounded-md hover:opacity-90 font-medium"
        >
          Save & add new
        </button>
        <button
          type="button"
          (click)="saveRule()"
          class="w-full px-4 py-2 bg-primary text-white rounded-md hover:opacity-90 font-medium"
        >
          {{ editingRuleId() ? 'Update rule' : 'Add rule' }}
        </button>
      </div>
    </form>
  </div>
</div>

@if (showContextModal()) {
<div
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  (click)="closeContextModal()"
>
  <div
    class="bg-card rounded-md shadow-lg p-6 max-w-2xl w-full mx-4 border border-border"
    (click)="$event.stopPropagation()"
  >
    <div class="flex items-center justify-between mb-3">
      <div>
        <h3 class="text-xl font-semibold text-text">User context</h3>
        <p class="text-xs text-muted">
          Define context fields users can fill before submitting the form.
        </p>
      </div>
      <button
        type="button"
        (click)="addContextRow()"
        class="px-3 py-1.5 text-xs border border-border rounded-md text-text hover:bg-bg"
      >
        Add field
      </button>
    </div>

    <form
      [formGroup]="contextFormGroup"
      (ngSubmit)="saveContextRows()"
      class="space-y-4"
    >
      <div
        formArrayName="entries"
        class="space-y-3 max-h-96 overflow-auto pr-1"
      >
        @for (group of contextForm.controls; let i = $index; track i) {
        <div
          class="grid grid-cols-12 gap-3 items-start border border-border rounded-md p-3 bg-bg"
          [formGroupName]="i"
        >
          <div class="col-span-4">
            <label class="text-sm text-text font-medium">Key</label>
            <input
              type="text"
              formControlName="key"
              class="w-full mt-1 px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
              placeholder="role"
            />
          </div>
          <div class="col-span-4">
            <label class="text-sm text-text font-medium">Display name</label>
            <input
              type="text"
              formControlName="displayName"
              class="w-full mt-1 px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
              placeholder="Role"
            />
          </div>
          <div class="col-span-3">
            <label class="text-sm text-text font-medium">Default value</label>
            <input
              type="text"
              formControlName="value"
              class="w-full mt-1 px-3 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-primary text-text bg-card"
              placeholder="Admin"
            />
          </div>
          <div class="col-span-1 flex justify-end pt-6">
            <button
              type="button"
              (click)="removeContextRow(i)"
              class="p-2 text-muted hover:text-danger transition-colors"
              title="Remove"
            >
              <app-icon name="delete" class="w-5 h-5"></app-icon>
            </button>
          </div>
        </div>
        }
      </div>

      <div class="flex justify-end gap-3 pt-2">
        <button
          type="button"
          (click)="closeContextModal()"
          class="px-4 py-2 border border-border text-text rounded-md hover:bg-bg font-medium"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="px-4 py-2 bg-primary text-white rounded-md hover:opacity-90 font-medium"
        >
          Save context
        </button>
      </div>
    </form>
  </div>
</div>
}
